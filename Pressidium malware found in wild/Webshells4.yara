/*
Author: Spyros Maris
Date: 27/10/2023
GitHub: https://github.com/pressidium/pressidium-yara-rules
*/

/* ------------------------------ Rule Set ------------------------------ */
/* 
This rules set detects specific malicious PHP code snippets that found in some wordpress sites hosted in Pressidium.
*/

rule malicious_PHP_code_snippet10
{
    meta:
        author = "Spyros Maris"
        date = "27/10/2023"
        description = "This rule detects specific malicious PHP code snippets that found in some wordpress sites hosted in Pressidium"
        reference = "https://github.com/pressidium/pressidium-yara-rules"
    strings:
        $password_assignment = "password = " ascii wide nocase
        $leaf_version_assignment = "['version']=" ascii wide nocase
        $leaf_website_assignment = "['website']=" ascii wide nocase
        $session_start = "session_start();" ascii wide nocase
        $error_reporting = "error_reporting(0);" ascii wide nocase
        $set_time_limit = "set_time_limit(0);" ascii wide nocase
        $memory_limit = "ini_set(\"memory_limit\",-1);" ascii wide nocase
        $session_md5 = "md5(__FILE__)" ascii wide nocase
        $session_code_check = "$_SESSION[" ascii wide nocase
        $request_pass_check = "isset($_REQUEST['pass'])" ascii wide nocase

    condition:
        3 of them
}

rule malicious_PHP_snippet11
{
    meta:
        author = "Spyros Maris"
        date = "27/10/2023"
        description = "This rule detects specific malicious PHP code snippets that found in some wordpress sites hosted in Pressidium"
        reference = "https://github.com/pressidium/pressidium-yara-rules"
    strings:
        $string1 = "rawurldecode" ascii wide nocase
        $string2 = "str_rot13" ascii wide nocase
        $string3 = "file_put_contents" ascii wide nocase
        $string4 = "base64_decode" ascii wide nocase
        $string5 = "28c754cd-7e52-42c6-9c21-792cd3873e65" ascii wide nocase
        $string6 = "2343d8d3-1d44-49e7-a1f6-455c2badd978" ascii wide nocase
        $string7 = "<?=123*4;echo `$_GET[0]`; ?>" ascii wide nocase
        $chr_pattern = /chr\(\d+(-\d+)?\)/ ascii wide nocase
        $hex_pattern = /\\x[0-9A-Fa-f]{2}/ ascii wide nocase
    condition:
        any of them
}

rule malicious_PHP_snippet12
{
    meta:
        author = "Spyros Maris"
        date = "27/10/2023"
        description = "This rule detects specific malicious PHP code snippets that found in some wordpress sites hosted in Pressidium"
        reference = "https://github.com/pressidium/pressidium-yara-rules"
    strings:
        $obfuscated_function = /\$lwibrwbof\(\d+-\d+\)/
        $hex_string = /\x5c\x78[0-9a-fA-F]{2}/
        $function_sequence = /function.*_nkk_or\(\$rofegia,\s+\$eesmlbfmew\)/
        $cookie_merge_post = /\$_COOKIE;\s*\$szrspxsp\s*=\s*array_merge\(\$szrspxsp,\s*\$_POST\);/
        $encoded_string = /"\x37\x64-\x36\x34-\x34\x36\x38\x35-\x62\x37\x65\x62-\x37\x63\x31"/
        $hex_string2 = /\x5c\x78[0-9a-fA-F]{2}/
        $chr_function = /chr\s*\(\s*\d+\s*-\s*\d+\s*\)/
        $string_concat = /"\x73".*?"\x72".*?chr/
        $eval_function = /eval\s*\(\s*\$[a-zA-Z_]\w*\s*\[\d+\]\s*\(.*\)\s*\);/
        $array_merge_pattern = /foreach\s*\(.*Array\(.*\$_POST,.*\$_COOKIE,.*\)\s*as\s*\$[a-zA-Z_]\w*\)/
        $include_string = /@include\s*\("\S+"\);/
    condition:
        1 of them
}

rule malicious_PHP_snippet13
{
    meta:
        author = "Spyros Maris"
        date = "27/10/2023"
        description = "This rule detects specific malicious PHP code snippets that found in some wordpress sites hosted in Pressidium"
        reference = "https://github.com/pressidium/pressidium-yara-rules"
    strings:
        $string_concat = /'\w+'.'\w+'.'\w+'.'\w+'/
        $array_merge_pattern = /array_merge\(\$_GET, \$_COOKIE, \$_POST\);/
        $eval_function = /@?eval\(\w+\(\w+\['\w+'\]\)\);/
        $file_operation_functions = /'f'.'\w+'.'\w+'/
        $md5_check = /if\(md5\(\w+\['\w+'\]\)===/
        $base64_decode_pattern = /'ba'.'se'.chr\(54\).chr\(64\).chr\(95\).chr\(100\).chr\(101\).chr\(99\)./
        $include_pattern = /include\(\w+\(\w+\)\['uri'\]\);/
    condition:
        2 of them
}


rule malicious_PHP_snippet14
{
    meta:
        author = "Spyros Maris"
        date = "27/10/2023"
        description = "This rule detects specific malicious PHP code snippets that found in some wordpress sites hosted in Pressidium"
        reference = "https://github.com/pressidium/pressidium-yara-rules"
    strings:
        $header = "DrunkShell v 1.0.0" ascii wide nocase
        $pattern1 = /\$[A-Za-z0-9_]+\s*=\s*\$ABC\[\d+\]\.\$ABC\[\d+\];/ // This regex pattern searches for a sequence where a variable is being assigned a value formed by accessing and concatenating elements from an array named $ABC. 
        $php_session1 = /\$_SESSION\["mysql"\]/
        $php_session2 = /\["(\?:server|username|pwd|database)"\]/

        $mysqli_conn = /new mysqli\(.+?\);/
        $disable_error_reporting1 = /error_reporting\(0\);/
        $disable_error_reporting2 = /ini_set\("display_errors", FALSE\);/
        $disable_error_reporting3 = /ini_set\("log_errors", 0  \);/
        $disable_error_reporting4 = /ini_set\("error_log", NULL\);/
        $header1 = /header\("X-XSS-Protection: 0"\);/
        $authvar = "$auth = " ascii wide nocase
        $string = "DRUNK SHELL BETA" ascii wide nocase
        $string2 = "s4ndal.py" ascii wide nocase

    condition:
        2 of them
}

rule malicious_PHP_snippet15
{
    meta:
        author = "Spyros Maris"
        date = "27/10/2023"
        description = "This rule detects specific malicious PHP code snippets that found in some wordpress sites hosted in Pressidium"
        reference = "https://github.com/pressidium/pressidium-yara-rules"
    strings:
        $string_concat = /"b"."a"."se6"."4_"."d"."ec"."od"."e"/
        $chr_function = /chr\(\d+\)/
        $eval_function = /eval\(\w+\(\w+\['\w+'\]\)\);/
        $md5_function = /md5\(\w+\['\w+'\]\)/
        $base64_encoded_string = /ZmQ"."0"."NWR"."jZ"."GI0NGF"."iODVi"."Yj"."M2N"."WVmY"."TE4Zj"."Q4MTM3OGQ=/
    condition:
        2 of them
}


