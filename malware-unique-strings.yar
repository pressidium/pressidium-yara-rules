/*
Author: Spyros Maris
Date: 26/10/2023
GitHub: https://github.com/pressidium/pressidium-yara-rules
*/

/* ------------------------------ Rule Set ------------------------------ */
/* 
This rules set detects specific malicious PHP code snippets that found in some wordpress sites hosted in Pressidium.
*/
/*For ease of use we add a comment in our includes with all the rulenames*/

include "Commons/Pressidium-common-encodings.yar" // rulenames: common_encoding_php , obfuscated_common_encodings_php 
include "Commons/Pressidium-common-eval-usage.yar" // rulenames: Detect_Eval_Usage
include "Commons/Pressidium-common-shell-commands.yar" // rulenames: common_unix_commands, common_uxin_commands_base64
include "Commons/Pressidium-common-PHP-functions.yar" // rulenames: common_PHP_functions, common_PHP_functions_base64_encoded
include "Commons/Pressidium-common-error-reporting.yar" //rulenames: common_disable_error_reporting


rule malicious_PHP_code_snippet1
{
    meta:
        author = "Spyros Maris"
        description = "Detects a specific malicious PHP code snippet"
        reference = "https://github.com/pressidium/pressidium-yara-rules"
        date = "26/10/2023"
    strings:
        $info_leak = /echo\s+php_uname\(\)\s*\.\s*"<br>"\s*\.\s*getcwd\(\)\s*\.\s*"<br>";/ wide ascii
        $file_upload = /<form method='POST' enctype='multipart\/form-data'><input type='file' name='file' \/><input type='submit' value='UPload' \/><\/form>/ wide ascii
        $move_uploaded_file = "move_uploaded_file(" wide ascii
        $curl_function = /function curl\(\s*\$url\s*\)\s*\{/ wide ascii
    condition:
        any of them and (1 of (common_encoding_php, obfuscated_common_encodings_php, Detect_Eval_Usage, common_unix_commands, common_uxin_commands_base64, common_PHP_functions, common_PHP_functions_base64_encoded, common_disable_error_reporting))

}

rule malicious_PHP_code_snippet2
{
    meta:
        author = "Spyros Maris"
        description = "Detects a specific malicious PHP code snippet"
        reference = "https://github.com/pressidium/pressidium-yara-rules"
        date = "26/10/2023"
    strings:
        $func_def = "if (!function_exists('explode'))" ascii
        $function_crgwr = "function Crgwr()" ascii
        $unlink_func = "unlink(__FILE__);" ascii
        $uniq_string = "I could not have a more welcome visitor 64 group of zain bani" ascii 
    condition:
        any of them and (1 of (common_encoding_php, obfuscated_common_encodings_php, Detect_Eval_Usage, common_unix_commands, common_uxin_commands_base64, common_PHP_functions, common_PHP_functions_base64_encoded, common_disable_error_reporting))
}

rule Obfuscated_malicious_PHP_code_snippet1
{
    meta:
        author = "Spyros Maris"
        description = "Detects a specific obfuscated malicious PHP code snippet"
        reference = "https://github.com/pressidium/pressidium-yara-rules"
        date = "26/10/2023"
    strings:
        $suspicious_function1 = "lIrHtGzZuKk" ascii
        $suspicious_function2 = "ofBzgiUxK" ascii
        $encoded_string = "UGRyT21YcFJ0TUZ1cUxvSWilGGlzm8jyB7jK/2HMqgJUMMi2nN3Yxo5WxkeVbPkhlGs3RSEYIfIQUBzr4yW//fUMIA1" ascii    
    condition:
        any of them and (1 of (common_encoding_php, obfuscated_common_encodings_php, Detect_Eval_Usage, common_unix_commands, common_uxin_commands_base64, common_PHP_functions, common_PHP_functions_base64_encoded, common_disable_error_reporting))
}